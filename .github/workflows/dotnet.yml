name: Build and Release ASP.NET Core App

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Build and test ASP.NET Core app
      run: |
        dotnet build
        dotnet test
    - name: Create Release
      if: success()
      run: |
        # get latest release tag
        LATEST_RELEASE_TAG=$(git describe --tags --abbrev=0)
        # check if there are any releases
        if [ -z "$LATEST_RELEASE_TAG" ]; then
          # set initial version number
          NEW_VERSION="1.0.0"
        else
          # increment version number
          NEW_VERSION=$(awk -F. -v OFS=. '{ if (NF == 1) { $NF++; } else { if (length($NF+1) > length($NF)) $(NF-1)++; $NF=sprintf("%0*d", length($NF), ($NF+1)%(10^length($NF))); } print }' <<< "$LATEST_RELEASE_TAG")
        fi
